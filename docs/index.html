<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Package Matcher Builder</title>
    <style>
      :root {
        --primary: #2563eb;
        --danger: #dc2626;
        --success: #16a34a;
        --bg: #f8fafc;
        --card: #ffffff;
        --border: #e2e8f0;
        --text: #0f172a;
        --text-muted: #64748b;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        line-height: 1.5;
        margin: 0;
      }

      .container {
        max-width: 900px;
        width: 100%;
        display: grid;
        gap: 1rem;
        margin: 0 auto;
        margin-top: 1rem;
        margin-bottom: 1rem;
      }

      header {
        background: #ffffff;
        position: sticky;
        top: 0;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
      }

      h2 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        padding: 0.5rem 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .form-group {
        margin-bottom: 1rem;
      }

      label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      input[type="text"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        font-size: 1rem;
        box-sizing: border-box;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .input-group {
        display: flex;
        gap: 0.5rem;
      }

      button {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9rem;
      }

      button:hover {
        opacity: 0.9;
      }

      button.danger {
        background-color: var(--danger);
      }

      button.secondary {
        background-color: transparent;
        border: 1px solid var(--border);
        color: var(--text);
      }

      button.secondary:hover {
        background-color: var(--bg);
      }

      .list-container {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        background: var(--bg);
      }

      .status-badge {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        margin-right: 0.5rem;
        font-weight: 600;
      }

      .status-pass {
        background-color: #dcfce7;
        color: #166534;
      }

      .status-fail {
        background-color: #fee2e2;
        color: #991b1b;
      }

      textarea {
        width: 100%;
        height: 200px;
        font-family: monospace;
        padding: 1rem;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        resize: vertical;
        box-sizing: border-box;
      }

      .toolbar {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .helper-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Matcher Builder</h1>
    </header>

    <div class="container">
      <!-- Regex Section -->
      <div class="card">
        <h2>Matcher Configuration</h2>

        <div class="form-group">
          <label for="keywordInput">Package Keyword (Auto-Generator)</label>
          <input type="text" id="keywordInput" placeholder="e.g. git" />
          <p class="helper-text">
            Type a keyword to auto-generate the regex pattern below.
          </p>
        </div>

        <div class="form-group">
          <label for="regexInput">Regular Expression</label>
          <input
            type="text"
            id="regexInput"
            placeholder="e.g. (?i)^(?:.*)\bgit\b"
            value="(?i)^(?:.*)\b\b"
          />
          <p class="helper-text">Standard Go regex syntax.</p>
        </div>
      </div>

      <!-- Tests Section -->
      <div class="grid-2">
        <!-- OK Tests -->
        <div class="card">
          <h2>Test OK (Should Match)</h2>
          <div class="input-group">
            <input
              type="text"
              id="okInput"
              placeholder="Enter string..."
              onkeydown="handleEnter(event, 'ok')"
            />
            <button onclick="addItem('ok')">Add</button>
          </div>
          <div id="okList" class="list-container"></div>
        </div>

        <!-- Fail Tests -->
        <div class="card">
          <h2>Test Fail (Should Not Match)</h2>
          <div class="input-group">
            <input
              type="text"
              id="failInput"
              placeholder="Enter string..."
              onkeydown="handleEnter(event, 'fail')"
            />
            <button onclick="addItem('fail')">Add</button>
          </div>
          <div id="failList" class="list-container"></div>
        </div>
      </div>

      <!-- Packages Section -->
      <div class="card">
        <h2>Packages</h2>
        <div class="input-group">
          <input
            type="text"
            id="pkgName"
            placeholder="Package Name"
            style="flex: 2"
          />
          <input
            type="text"
            id="pkgManager"
            placeholder="Manager (e.g. apt)"
            style="flex: 1"
            onkeydown="handleEnter(event, 'pkg')"
          />
          <button onclick="addPackage()">Add Package</button>
        </div>
        <div id="pkgList" class="list-container"></div>
      </div>

      <!-- Output Section -->
      <div class="card">
        <h2>JSON Output</h2>
        <textarea id="output" readonly></textarea>
        <div class="toolbar">
          <button class="secondary" onclick="copyToClipboard()">
            Copy to Clipboard
          </button>
          <button onclick="downloadJSON()">Download .json</button>
        </div>
      </div>
    </div>

    <script>
      // State
      const state = {
        matcher: "(?i)^(?:.*)\\b\\b",
        test_ok: [],
        test_fail: [],
        packages: [],
      };

      // DOM Elements
      const keywordInput = document.getElementById("keywordInput");
      const regexInput = document.getElementById("regexInput");
      const okListEl = document.getElementById("okList");
      const failListEl = document.getElementById("failList");
      const pkgListEl = document.getElementById("pkgList");
      const outputEl = document.getElementById("output");

      // Initialization

      // Auto-generator listener
      keywordInput.addEventListener("input", (e) => {
        const val = e.target.value.trim();
        // Escape special regex chars
        const escaped = val.replace(/[.*+?^${}()|[\\]/g, "\\$&");
        // We need double escaping for the JS string to literal conversion to hold a literal backslash + b
        const pattern = `(?i)^(?:.*)\\b${escaped}\\b`;
        state.matcher = pattern;
        regexInput.value = pattern;
        render();
      });

      regexInput.addEventListener("input", (e) => {
        state.matcher = e.target.value;
        render();
      });

      function handleEnter(e, type) {
        if (e.key === "Enter") {
          if (type === "pkg") addPackage();
          else addItem(type);
        }
      }

      function addItem(type) {
        const inputId = type === "ok" ? "okInput" : "failInput";
        const input = document.getElementById(inputId);
        const val = input.value.trim();

        if (val) {
          if (type === "ok") state.test_ok.push(val);
          else state.test_fail.push(val);

          input.value = "";
          render();
        }
      }

      function removeItem(type, index) {
        if (type === "ok") state.test_ok.splice(index, 1);
        else state.test_fail.splice(index, 1);
        render();
      }

      function addPackage() {
        const nameInput = document.getElementById("pkgName");
        const managerInput = document.getElementById("pkgManager");

        const name = nameInput.value.trim();
        const manager = managerInput.value.trim();

        if (name && manager) {
          state.packages.push({ name, manager });
          nameInput.value = "";
          managerInput.value = "";
          nameInput.focus();
          render();
        }
      }

      function removePackage(index) {
        state.packages.splice(index, 1);
        render();
      }

      function validateRegex(pattern, text) {
        try {
          // Handle Go-specific syntax for JS compatibility
          let jsPattern = pattern;
          let flags = "";

          // Handle (?i) case-insensitive flag
          if (jsPattern.startsWith("(?i)")) {
            flags += "i";
            jsPattern = jsPattern.substring(4);
          }

          const regex = new RegExp(jsPattern, flags);
          return regex.test(text);
        } catch (e) {
          console.error("Regex error:", e);
          return false;
        }
      }

      function render() {
        // Render OK List
        okListEl.innerHTML = state.test_ok
          .map((text, i) => {
            const matches = validateRegex(state.matcher, text);
            const statusClass = matches ? "status-pass" : "status-fail";
            const statusText = matches ? "PASS" : "FAIL";

            return `
                <div class="list-item">
                    <span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        ${text}
                    </span>
                    <button class="danger" onclick="removeItem('ok', ${i})" style="padding: 0.2rem 0.5rem; font-size: 0.8rem">×</button>
                </div>
            `;
          })
          .join("");

        // Render Fail List
        failListEl.innerHTML = state.test_fail
          .map((text, i) => {
            const matches = validateRegex(state.matcher, text);
            // Ideally it should NOT match. So if it matches, it's a fail.
            const passed = !matches;
            const statusClass = passed ? "status-pass" : "status-fail";
            const statusText = passed ? "PASS" : "FAIL";

            return `
                <div class="list-item">
                    <span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        ${text}
                    </span>
                    <button class="danger" onclick="removeItem('fail', ${i})" style="padding: 0.2rem 0.5rem; font-size: 0.8rem">×</button>
                </div>
            `;
          })
          .join("");

        // Render Packages
        pkgListEl.innerHTML = state.packages
          .map(
            (pkg, i) => `
            <div class="list-item">
                <span><strong>${pkg.name}</strong> <span style="color:var(--text-muted)">(${pkg.manager})</span></span>
                <button class="danger" onclick="removePackage(${i})" style="padding: 0.2rem 0.5rem; font-size: 0.8rem">×</button>
            </div>
        `,
          )
          .join("");

        // Update JSON Output
        const jsonOutput = JSON.stringify(state, null, 2);
        outputEl.value = jsonOutput;
      }

      function copyToClipboard() {
        outputEl.select();
        document.execCommand("copy");
        alert("Copied to clipboard!");
      }

      function downloadJSON() {
        const dataStr =
          "data:text/json;charset=utf-8," + encodeURIComponent(outputEl.value);
        const downloadAnchorNode = document.createElement("a");
        const filename = keywordInput.value.trim()
          ? keywordInput.value.trim() + ".json"
          : "matcher.json";
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", filename);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      }

      // Initial render
      render();
    </script>
  </body>
</html>
